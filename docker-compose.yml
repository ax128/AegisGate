services:
  aegisgate:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aegisgate
    ports:
      - "127.0.0.1:18080:18080"
    env_file:
      - ./config/.env
    environment:
      # 必改：容器内监听与生产标识
      AEGIS_ENV: "prod"
      AEGIS_HOST: "0.0.0.0"
      AEGIS_PORT: "18080"
      # 必改：Docker 内可写路径（默认 logs/ 可能不可写）
      AEGIS_SQLITE_DB_PATH: "/tmp/aegisgate.db"
      AEGIS_AUDIT_LOG_PATH: "/tmp/audit.jsonl"
      # 必改：允许非本机访问网关
      AEGIS_ENFORCE_LOOPBACK_ONLY: "false"
      # 必改：实际上游地址（或通过请求头 x-upstream-base 覆盖）
      AEGIS_UPSTREAM_BASE_URL: "https://your-upstream.example.com/v1"
    volumes:
      - ./logs:/app/logs
      # 策略与规则：宿主机 ./config 覆盖容器内策略目录，改 YAML 后重启即生效
      # 首次运行前请复制 aegisgate/policies/rules/* 到 ./config（含 default.yaml、security_filters.yaml 等）
      - ./config:/app/aegisgate/policies/rules
    restart: unless-stopped
