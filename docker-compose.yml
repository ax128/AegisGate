services:
  aegisgate:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aegisgate
    # 以 root 运行，避免 Docker Desktop/跨平台 bind mount 下 uid=10001 无写权限导致 sqlite 打不开
    user: "0:0"
    ports:
      - "127.0.0.1:18080:18080"
    # 首次启动时 config/.env 不存在也可启动；应用会从默认生成，之后可编辑 config/.env 覆盖
    env_file:
      - path: ./config/.env
        required: false
    environment:
      # 必改：容器内监听与生产标识
      AEGIS_ENV: "prod"
      AEGIS_HOST: "0.0.0.0"
      AEGIS_PORT: "18080"
      # 必改：允许非本机访问网关
      AEGIS_ENFORCE_LOOPBACK_ONLY: "false"
      # 必改：实际上游地址（或通过请求头 x-upstream-base 覆盖）
      AEGIS_UPSTREAM_BASE_URL: "https://your-upstream.example.com/v1"
      # 持久化到宿主机挂载目录
      AEGIS_SQLITE_DB_PATH: "/app/logs/aegisgate.db"
      AEGIS_AUDIT_LOG_PATH: "/app/logs/audit.jsonl"
      # token 映射落到宿主机 ./config/gw_tokens.json，重启后仍可用
      AEGIS_GW_TOKENS_PATH: "/app/aegisgate/policies/rules/gw_tokens.json"
    volumes:
      # 宿主机 ./logs 需可写：先执行 chown 10001:10001 logs 再 docker compose up
      - ./logs:/app/logs
      # 策略与 config：宿主机 ./config 挂载为容器内策略目录；首次为空时应用会自动生成 .env 与 YAML
      - ./config:/app/aegisgate/policies/rules
    restart: unless-stopped
