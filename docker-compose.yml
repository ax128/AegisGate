services:
  aegisgate:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aegisgate
    # 以 root 运行，避免 Docker Desktop/跨平台 bind mount 下 uid=10001 无写权限导致 sqlite 打不开
    user: "0:0"
    ports:
      - "127.0.0.1:18080:18080"
    expose:
      - "18080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # 首次启动时 config/.env 不存在也可启动；应用会从默认生成，之后可编辑 config/.env 覆盖
    env_file:
      - path: ./config/.env
        required: false
    environment:
      # 容器内监听与生产标识
      AEGIS_ENV: "prod"
      AEGIS_HOST: "0.0.0.0"
      AEGIS_PORT: "18080"
      # Docker bridge 来源不是 loopback，需关闭该校验；对外暴露由 ports 绑定控制（当前仅 127.0.0.1）
      AEGIS_ENFORCE_LOOPBACK_ONLY: "false"
      # 必改：实际上游地址（或通过请求头 x-upstream-base 覆盖）
      AEGIS_UPSTREAM_BASE_URL: "https://your-upstream.example.com/v1"
      # 持久化到宿主机挂载目录
      AEGIS_SQLITE_DB_PATH: "/app/logs/aegisgate.db"
      AEGIS_AUDIT_LOG_PATH: "/app/logs/audit.jsonl"
      # token 映射落到宿主机 ./config/gw_tokens.json，重启后仍可用
      AEGIS_GW_TOKENS_PATH: "/app/aegisgate/policies/rules/gw_tokens.json"
      # 一键启动：容器启动时自动回填策略 YAML（default/security_filters/permissive/strict）
      AEGIS_INIT_STRICT: "true"
      AEGIS_BOOTSTRAP_RULES_DIR: "/app/bootstrap/rules"
      AEGIS_SECURITY_RULES_PATH: "/app/aegisgate/policies/rules/security_filters.yaml"
    volumes:
      # 宿主机 ./logs 需可写：先执行 chown 10001:10001 logs 再 docker compose up
      - ./logs:/app/logs
      # 策略与 config：宿主机 ./config 挂载为容器内策略目录；首次为空会自动生成策略文件
      - ./config:/app/aegisgate/policies/rules
    restart: unless-stopped
