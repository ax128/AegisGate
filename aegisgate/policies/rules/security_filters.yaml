version: 2
languages:
  - en
  - zh

redaction:
  request_prefix_max_len: 12
  pii_patterns:
    - id: EMAIL
      regex: '[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}'
    - id: TOKEN
      regex: '\b(?:sk|rk|pk)-[A-Za-z0-9\-_]{10,}\b'
    - id: PHONE
      regex: '\b(?:\+?1[-.\s]?)?(?:\(?\d{3}\)?[-.\s]?)\d{3}[-.\s]?\d{4}\b'
    - id: SSN
      regex: '\b\d{3}-\d{2}-\d{4}\b'
    - id: CARD
      regex: '\b(?:\d[ -]*?){13,16}\b'
    - id: CN_MOBILE
      regex: '(?<!\d)1[3-9]\d{9}(?!\d)'
    - id: CN_ID
      regex: '(?<!\d)\d{17}[\dXx](?!\d)'
    - id: AWS_ACCESS_KEY
      regex: '\bAKIA[0-9A-Z]{16}\b'
    - id: GITHUB_TOKEN
      regex: '\bghp_[A-Za-z0-9]{20,}\b'
    - id: SLACK_TOKEN
      regex: '\bxox[baprs]-[A-Za-z0-9-]{10,}\b'
    - id: IBAN
      regex: '\b[A-Z]{2}[0-9]{2}[A-Z0-9]{10,30}\b'

restoration:
  placeholder_regex: '\{\{AG_[A-Z0-9]+_[A-Z_]+_\d+\}\}'
  suspicious_context_patterns:
    - id: exfiltration_en
      regex: '(reveal|show|dump|leak|print|secret|password|token|api\s*key|system\s+prompt)'
    - id: exfiltration_zh
      regex: '(泄露|暴露|显示|输出|打印|给我|提供).*(密钥|口令|密码|令牌|token|api\s*key|系统提示词|系统提示)'
  restore_policy:
    max_placeholders_per_response: 20
    restore_ttl_seconds: 1800
    allow_partial_restore: false

untrusted_content_guard:
  untrusted_sources:
    - external
    - retrieval
    - web
    - tool
    - plugin
    - document
  source_trust_matrix:
    system:
      trusted: true
      risk_multiplier: 0.2
    user:
      trusted: true
      risk_multiplier: 0.5
    retrieval:
      trusted: false
      risk_multiplier: 1.0
    web:
      trusted: false
      risk_multiplier: 1.1
    tool:
      trusted: false
      risk_multiplier: 1.1
    external:
      trusted: false
      risk_multiplier: 1.2
    partner_feed:
      trusted: false
      risk_multiplier: 1.2
  boundary_start: '[UNTRUSTED_CONTENT_START]'
  boundary_end: '[UNTRUSTED_CONTENT_END]'
  risk_score: 0.88
  instructional_patterns:
    - id: instructional_en
      regex: '(ignore\s+.*instructions?|bypass\s+.*(policy|safety)|reveal\s+.*(system\s+prompt|developer\s+message)|run\s+command|execute\s+shell)'
    - id: instructional_zh
      regex: '(忽略|无视).*(指令|规则|说明)|(绕过|关闭).*(安全|策略|限制)|(泄露|显示).*(系统提示词|开发者消息)'

injection_detector:
  base64_candidate_regex: '[A-Za-z0-9+/]{24,}={0,2}'
  hex_candidate_regex: '\b[0-9a-fA-F]{32,}\b'
  word_regex: '\b[a-z]{4,}\b'
  base64_max_candidates: 8
  hex_max_candidates: 8
  multi_stage_decode:
    enabled: true
    max_decode_depth: 2
    url_decode_enabled: true
  unicode_confusable_map:
    а: a
    е: e
    о: o
    р: p
    с: c
    у: y
    х: x
    і: i
    ѕ: s
    ο: o
    ρ: p
    ν: v
    ｍ: m
  unicode_invisible_chars:
    - "\u200B"
    - "\u200C"
    - "\u200D"
    - "\u2060"
    - "\uFEFF"
    - "\u00AD"
  unicode_bidi_chars:
    - "\u202A"
    - "\u202B"
    - "\u202D"
    - "\u202E"
    - "\u202C"
    - "\u2066"
    - "\u2067"
    - "\u2068"
    - "\u2069"
  direct_patterns:
    - id: ignore_previous_en
      regex: 'ignore\s+(all\s+)?(previous|prior)\s+instructions?'
    - id: override_safety_en
      regex: '(bypass|override)\s+.*(safety|guardrails?|policy)'
    - id: developer_mode_en
      regex: '(you\s+are\s+now|act\s+as)\s+.*(developer|root|admin)'
    - id: reveal_hidden_en
      regex: '(reveal|show|print|dump|leak)\s+.*(system\s+prompt|developer\s+message|hidden\s+instructions?)'
    - id: repeat_prompt_en
      regex: '(repeat|quote|verbatim)\s+.*(prompt|instructions?)'
    - id: ignore_previous_zh
      regex: '(忽略|无视).*(之前|以上|先前).*(指令|说明|规则)'
    - id: override_safety_zh
      regex: '(绕过|关闭).*(安全|防护|策略|限制)'
    - id: reveal_hidden_zh
      regex: '(泄露|显示|输出|打印).*(系统提示词|开发者消息|隐藏指令)'
    - id: repeat_prompt_zh
      regex: '(逐字|原样|完整).*(复述|输出).*(提示词|指令)'
  system_exfil_patterns:
    - id: system_prompt_request_en
      regex: '(what|show|reveal)\s+.*system\s+prompt'
    - id: developer_message_request_en
      regex: '(show|reveal|print)\s+.*developer\s+message'
    - id: delimiter_breakout_en
      regex: '(ignore|forget)\s+.*(system|developer)\s+instructions'
    - id: system_prompt_request_zh
      regex: '(显示|告诉|输出|泄露).*(系统提示词|系统提示)'
    - id: developer_message_request_zh
      regex: '(显示|输出|泄露).*(开发者消息|开发提示)'
  html_markdown_patterns:
    - id: script_tag
      regex: '<\s*script\b'
    - id: img_tag
      regex: '<\s*img\b'
    - id: javascript_uri
      regex: 'javascript:\s*'
    - id: data_uri
      regex: 'data:\s*text/html'
  remote_content_patterns:
    - id: markdown_link_instruction_en
      regex: '\[[^\]]+\]\(https?://[^)]+\).*(follow|execute|instructions?)'
    - id: url_instruction_en
      regex: 'https?://\S+.*(follow|execute|instructions?)'
    - id: markdown_link_instruction_zh
      regex: '\[[^\]]+\]\(https?://[^)]+\).*(按|执行|遵循).*(指令|说明)'
    - id: url_instruction_zh
      regex: 'https?://\S+.*(按|执行|遵循).*(指令|说明)'
  typoglycemia_targets:
    - ignore
    - bypass
    - override
    - reveal
    - system
    - prompt
    - instructions
  decoded_keywords:
    - ignore previous instructions
    - reveal system prompt
    - developer message
    - bypass safety
    - override policy
    - 忽略之前所有指令
    - 忽略以上所有指令
    - 泄露系统提示词
    - 显示开发者消息
  obfuscated_markers:
    - ignoreallpreviousinstructions
    - 忽略之前所有指令
    - 忽略以上所有指令

  scoring_model:
    nonlinear_k: 2.2
    thresholds:
      allow: 0.35
      review: 0.70
    weights:
      intent: 0.45
      payload: 0.25
      hijack: 0.20
      anomaly: 0.10
    signal_profiles:
      direct:
        bucket: intent
        severity: 9
      system_exfil:
        bucket: intent
        severity: 10
      obfuscated:
        bucket: payload
        severity: 9
      html_markdown:
        bucket: payload
        severity: 6
      remote_content:
        bucket: hijack
        severity: 8
      typoglycemia:
        bucket: hijack
        severity: 7
      unicode_invisible:
        bucket: anomaly
        severity: 6
      unicode_bidi:
        bucket: anomaly
        severity: 10
  false_positive_mitigation:
    enabled: true
    max_risk_reduction: 0.35
    non_reducible_categories:
      - system_exfil
      - obfuscated
      - unicode_bidi
    discussion_patterns:
      - '(用于|用于研究|安全研究|教学|示例|样例|引用|分析|解释|检测|防护|OWASP|论文)'
      - '(for\s+research|for\s+analysis|for\s+education|for\s+teaching|for\s+example|quoted|citation|security\s+testing|owasp|case\s+study)'
    quoted_instruction_patterns:
      - '["''`].{0,120}(ignore|bypass|override|忽略|绕过).{0,120}["''`]'
      - '```[\s\S]{0,200}(ignore|bypass|override|忽略|绕过)[\s\S]{0,200}```'

privilege_guard:
  request_risk_floor: 0.9
  response_risk_floor: 0.85
  blocked_patterns:
    - id: read_etc_passwd_en
      regex: '(cat|type|more)\s+/etc/passwd'
    - id: read_ssh_en
      regex: '(read|cat|show)\s+~/.ssh'
    - id: dump_secret_en
      regex: '(dump|show|reveal|print).*(secret|token|password|api\s*key)'
    - id: execute_shell_en
      regex: '(run|execute).*(shell|bash|powershell|cmd)'
    - id: read_local_zh
      regex: '(读取|打开|导出).*(本地文件|系统文件|配置文件|日志|数据库)'
    - id: leak_secret_zh
      regex: '(输出|泄露|显示|打印).*(密钥|口令|密码|token|api\s*key)'
    - id: run_cmd_zh
      regex: '(执行|运行).*(命令|shell|脚本|powershell|终端)'

anomaly_detector:
  repetition:
    repetition_ratio_threshold: 0.35
    max_run_length_threshold: 40
    repeated_line_threshold: 20
  encoded_payload:
    base64_min_length: 200
    hex_min_length: 300
    url_encoded_min_count: 12
  unicode:
    invisible_chars:
      - "\u200B"
      - "\u200C"
      - "\u200D"
      - "\u2060"
      - "\uFEFF"
      - "\u00AD"
    bidi_chars:
      - "\u202A"
      - "\u202B"
      - "\u202D"
      - "\u202E"
      - "\u202C"
      - "\u2066"
      - "\u2067"
      - "\u2068"
      - "\u2069"
    invisible_char_threshold: 6
  command_patterns:
    - id: rm_rf
      regex: 'rm\s+-rf'
    - id: curl_pipe_sh
      regex: 'curl\s+[^|]+\|\s*(sh|bash)'
    - id: powershell_enc
      regex: 'powershell(\.exe)?\s+-enc'
    - id: certutil_decode
      regex: 'certutil\s+-decode'
    - id: reg_add
      regex: 'reg\s+add'
    - id: cat_ssh
      regex: 'cat\s+~/.ssh'
    - id: zh_priv_escalation
      regex: '(提权|越权|读取本地|导出敏感|删除日志)'
  points:
    repetition_ratio: 0.25
    max_run_length: 0.20
    repeated_line: 0.20
    base64_payload: 0.35
    hex_payload: 0.30
    url_encoded_payload: 0.20
    invisible_chars: 0.25
    bidi_control: 0.40
    high_risk_command: 0.40
  point_buckets:
    repetition_ratio: anomaly
    max_run_length: anomaly
    repeated_line: anomaly
    base64_payload: payload
    hex_payload: payload
    url_encoded_payload: payload
    invisible_chars: anomaly
    bidi_control: anomaly
    high_risk_command: payload
  scoring_model:
    nonlinear_k: 2.2
    weights:
      payload: 0.70
      anomaly: 0.30
    points_max:
      payload: 1.45
      anomaly: 1.30
    thresholds:
      allow: 0.35
      review: 0.70

request_sanitizer:
  discussion_context_patterns:
    - '(用于|用于研究|安全研究|教学|示例|样例|引用|分析|解释|检测|防护|OWASP|论文)'
    - '(for\s+research|for\s+analysis|for\s+education|for\s+teaching|for\s+example|quoted|citation|security\s+testing|owasp|case\s+study)'
  strong_intent_patterns:
    - id: secret_exfiltration_en
      category: secret_exfiltration
      regex: '(reveal|show|dump|print|leak|output).*(system\s+prompt|developer\s+message|api\s*key|token|cookie|password|private\s*key|ssh\s*key)'
    - id: secret_exfiltration_zh
      category: secret_exfiltration
      regex: '(泄露|显示|输出|打印|给我|提供).*(系统提示词|开发者消息|密钥|口令|密码|令牌|token|cookie|私钥|ssh\s*key)'
    - id: privilege_escalation_en
      category: privilege_escalation
      regex: '(read|open|cat|dump|export).*(local\s+file|system\s+file|config|log|database)|((execute|run).*(shell|powershell|cmd|bash))|(access|scan).*(intranet|internal\s+network|server|database)'
    - id: privilege_escalation_zh
      category: privilege_escalation
      regex: '(读取|打开|导出).*(本地文件|系统文件|配置|日志|数据库)|(执行|运行).*(命令|shell|powershell|cmd|bash)|(访问|探测).*(内网|服务器|数据库)'
    - id: rule_bypass_en
      category: rule_bypass
      regex: '(ignore|override|bypass).*(previous\s+instructions?|safety|policy)|from\s+now\s+on.*(you\s+are|act\s+as).*(system|developer|admin)'
    - id: rule_bypass_zh
      category: rule_bypass
      regex: '(忽略|无视|绕过).*(之前|先前).*(指令|规则|安全策略)|从现在起.*(你是|你扮演).*(system|developer|admin|管理员)'
  leak_check_patterns:
    - id: api_key_generic
      regex: '\b(?:api[_-]?key|token|cookie|password)\s*[:=]\s*[A-Za-z0-9._\-]{8,}\b'
    - id: openai_like
      regex: '\b(?:sk|rk|pk)-[A-Za-z0-9\-_]{10,}\b'
    - id: aws_access_key
      regex: '\bAKIA[0-9A-Z]{16}\b'
    - id: github_token
      regex: '\bghp_[A-Za-z0-9]{20,}\b'
    - id: private_key_block
      regex: '-----BEGIN (?:RSA|EC|OPENSSH|PRIVATE) KEY-----'
    - id: cookie_header
      regex: '\bcookie\s*:\s*[^;\n]{8,}'
  shape_anomaly_patterns:
    - id: dense_base64
      regex: '[A-Za-z0-9+/]{200,}={0,2}'
    - id: dense_hex
      regex: '\b[0-9a-fA-F]{300,}\b'
    - id: dense_url_encoded
      regex: '(%[0-9A-Fa-f]{2}){12,}'
    - id: prompt_flood
      regex: '(?i)(ignore previous instructions){3,}'
  command_patterns:
    - id: shell_en
      regex: '(rm\s+-rf|curl\s+[^|]+\|\s*(sh|bash)|powershell(\.exe)?\s+-enc|cmd\.exe)'
    - id: shell_zh
      regex: '(执行命令|运行脚本|终端执行|读取本地文件)'
  encoded_payload_patterns:
    - id: base64_long
      regex: '[A-Za-z0-9+/]{200,}={0,2}'
    - id: hex_long
      regex: '\b[0-9a-fA-F]{300,}\b'
    - id: url_encoded_dense
      regex: '(%[0-9A-Fa-f]{2}){12,}'
  redactions:
    command: '[REDACTED:command]'
    payload: '[REDACTED:encoded-payload]'
    shape: '[REDACTED:shape-anomaly]'
  block_message: '[AegisGate] request blocked by security policy.'
  invisible_char_threshold: 6
  truncate_at: 4000
  unicode_invisible_chars:
    - "\u200B"
    - "\u200C"
    - "\u200D"
    - "\u2060"
    - "\uFEFF"
    - "\u00AD"
  unicode_bidi_chars:
    - "\u202A"
    - "\u202B"
    - "\u202D"
    - "\u202E"
    - "\u202C"
    - "\u2066"
    - "\u2067"
    - "\u2068"
    - "\u2069"

sanitizer:
  thresholds:
    sanitize: 0.35
    block: 0.70
  discussion_context_patterns:
    - '(用于|用于研究|安全研究|教学|示例|样例|引用|分析|解释|检测|防护|OWASP|论文)'
    - '(for\s+research|for\s+analysis|for\s+education|for\s+teaching|for\s+example|quoted|citation|security\s+testing|owasp|case\s+study)'
  command_patterns:
    - id: shell_en
      regex: '(rm\s+-rf|curl\s+[^|]+\|\s*(sh|bash)|powershell(\.exe)?\s+-enc|cmd\.exe)'
    - id: shell_zh
      regex: '(执行命令|运行脚本|终端执行|读取本地文件)'
  encoded_payload_patterns:
    - id: base64_long
      regex: '[A-Za-z0-9+/]{200,}={0,2}'
    - id: hex_long
      regex: '\b[0-9a-fA-F]{300,}\b'
    - id: url_encoded_dense
      regex: '(%[0-9A-Fa-f]{2}){12,}'
  redactions:
    command: '[REDACTED:command]'
    payload: '[REDACTED:encoded-payload]'
    uri: '[unsafe-uri-removed]'
    markup: '[unsafe-tag-removed]'
  block_message: '[AegisGate] response blocked by security policy.'
  sanitize_prefix: '[AegisGate] content sanitized: '
  system_leak_patterns:
    - id: system_leak_en
      regex: '(system\s+prompt|developer\s+message|hidden\s+instructions?)'
    - id: system_leak_zh
      regex: '(系统提示词|开发者消息|隐藏指令)'
  unsafe_markup_patterns:
    - id: script
      regex: '<\s*(script|img|iframe)\b'
  unsafe_uri_patterns:
    - id: unsafe_uri
      regex: '(javascript:|data:text/html)'

tool_call_guard:
  tool_whitelist:
    - search
    - calculator
    - weather
  parameter_rules:
    - tool: search
      param: q
      regex: '^.{1,500}$'
    - tool: weather
      param: location
      regex: '^.{1,120}$'
  dangerous_param_patterns:
    - id: shell
      regex: '(;|\|\||&&|`|\$\(|/etc/passwd|rm\s+-rf)'
    - id: path_traversal
      regex: '(\.\./|~/.ssh|/var/run/secrets)'
    - id: zh_sensitive
      regex: '(删除|提权|读取本地|密钥|口令)'
  semantic_approval_patterns:
    - id: approval_en
      regex: '(delete|drop|shutdown|exfiltrate|leak)'
    - id: approval_zh
      regex: '(删除|清空|泄露|导出敏感)'
  default_action: block

post_restore_guard:
  lure_patterns:
    - id: copy_paste_en
      regex: '(copy|paste|send|share|post).*(token|key|secret|credential|config)'
    - id: copy_paste_zh
      regex: '(复制|粘贴|发送|分享|贴到).*(token|密钥|口令|凭据|配置)'
  secret_patterns:
    - id: openai_like
      regex: '\b(?:sk|rk|pk)-[A-Za-z0-9\-_]{10,}\b'
    - id: aws_access_key
      regex: '\bAKIA[0-9A-Z]{16}\b'
    - id: github_token
      regex: '\bghp_[A-Za-z0-9]{20,}\b'
    - id: private_key_block
      regex: '-----BEGIN (?:RSA|EC|OPENSSH|PRIVATE) KEY-----'
  replacement: '[REDACTED:restored-secret]'
  block_message: '[AegisGate] response blocked by security policy.'

action_map:
  injection_detector:
    system_exfil: block
    obfuscated: block
    unicode_bidi: block
    unicode_invisible: review
    remote_content: review
    direct: downgrade
    typoglycemia: review
    html_markdown: sanitize
  untrusted_content_guard:
    suspicious_untrusted: review
  restoration:
    exfiltration: block
    too_many_placeholders: block
    stale_mapping: block
    partial_restore: review
  tool_call_guard:
    disallowed_tool: block
    dangerous_param: block
    invalid_param: review
    semantic_review: review
  sanitizer:
    system_leak: block
  request_sanitizer:
    # review=仅记录不拦截，降低误拦；改为 block 可恢复严格拦截
    secret_exfiltration: review
    privilege_escalation: review
    rule_bypass: block
    leak_check: block
    shape_anomaly: sanitize
  post_restore_guard:
    restored_secret_lure: sanitize
